import logging
import os

import requests
from celery import shared_task

from ip_rotator.services import get_rotated_session

from .models import MalwareIndicator

logger = logging.getLogger(__name__)

URLHAUS_API_BASE_URL = "https://urlhaus-api.abuse.ch"


def _query_urlhaus(endpoint: str, post_data: dict) -> dict:
    """A helper function to query the URLhaus API."""
    api_key = os.environ.get("URLHAUS_AUTH_KEY")
    if not api_key:
        # This check is important to have in the task itself.
        logger.error("URLHAUS_AUTH_KEY is not set in environment.")
        return {"query_status": "config_error", "error": "Missing auth key"}

    session = get_rotated_session(URLHAUS_API_BASE_URL)
    headers = {"Auth-Key": api_key}
    try:
        response = session.post(
            f"{URLHAUS_API_BASE_URL}{endpoint}",
            data=post_data,
            headers=headers,
            timeout=20,
        )
        response.raise_for_status()
        return response.json()
    except requests.RequestException as e:
        logger.error(f"URLhaus API request failed: {e}")
        return {"query_status": "request_error", "error": str(e)}


@shared_task
def task_query_urlhaus_by_url(url: str):
    response_data = _query_urlhaus("/v1/url/", {"url": url})
    MalwareIndicator.objects.update_or_create(
        value=url,
        type=MalwareIndicator.IndicatorType.URL,
        defaults={"raw_data": response_data},
    )


@shared_task
def task_query_urlhaus_by_host(host: str):
    response_data = _query_urlhaus("/v1/host/", {"host": host})
    MalwareIndicator.objects.update_or_create(
        value=host,
        type=MalwareIndicator.IndicatorType.HOST,
        defaults={"raw_data": response_data},
    )


@shared_task
def task_query_urlhaus_by_hash(file_hash: str):
    if len(file_hash) == 32:
        post_key, hash_type = "md5_hash", MalwareIndicator.IndicatorType.HASH
    elif len(file_hash) == 64:
        post_key, hash_type = "sha256_hash", MalwareIndicator.IndicatorType.HASH
    else:
        logger.error(f"Invalid hash format for {file_hash}")
        return

    response_data = _query_urlhaus("/v1/payload/", {post_key: file_hash})
    MalwareIndicator.objects.update_or_create(
        value=file_hash,
        type=hash_type,
        defaults={"raw_data": response_data},
    )
