# Technical Plan: Kindi-BE3 Malware Intel App

## 1. Overview

The `malware_intel` app will enable Kindi users to query the URLhaus database for intelligence on malicious URLs, hosts (domains/IPs), and file hashes. The app will use the URLhaus query API, send all requests through the `ip_rotator` service, and manage the required authentication key.

## 2. Database Schema

A flexible model structure is needed to store the various types of malware intelligence data.

**File:** `malware_intel/models.py`

```python
import uuid
from django.db import models
from django.utils.translation import gettext_lazy as _

class MalwareIndicator(models.Model):
    """
    Represents a unique malware-related Indicator of Compromise (IOC).
    """
    class IndicatorType(models.TextChoices):
        URL = 'URL', _('URL')
        HOST = 'HOST', _('Host (Domain/IP)')
        HASH = 'HASH', _('File Hash')

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    value = models.CharField(max_length=2048, unique=True, db_index=True)
    type = models.CharField(max_length=4, choices=IndicatorType.choices)
    created_at = models.DateTimeField(auto_now_add=True)
    last_queried = models.DateTimeField(auto_now=True)
    raw_data = models.JSONField(help_text="The full, raw JSON response from the URLhaus API for this indicator.")

    def __str__(self):
        return f"{self.get_type_display()}: {self.value}"
```

## 3. Architecture & Core Logic

**File:** `malware_intel/services.py`

*   **`query_urlhaus_by_url(url: str)` function:**
    *   Takes a URL string.
    *   Uses `ip_rotator.services.get_rotated_session()` to get a session.
    *   Makes an authenticated `POST` request to the `/v1/url/` endpoint.
    *   Parses the JSON response.
    *   Creates or updates a `MalwareIndicator` record with the results in the `raw_data` field.
    *   Returns the `MalwareIndicator` object.

*   **`query_urlhaus_by_host(host: str)` function:**
    *   Similar to the URL function, but queries the `/v1/host/` endpoint.

*   **`query_urlhaus_by_hash(file_hash: str)` function:**
    *   Similar to the above, but queries the `/v1/payload/` endpoint, determining whether to use `md5_hash` or `sha256_hash` as the key based on the hash length.

## 4. API Endpoints

The API will provide separate endpoints for each type of query.

**File:** `malware_intel/views.py`, `malware_intel/serializers.py`, `malware_intel/urls.py`

*   **`POST /api/v1/malware-intel/url/`**
    *   **Action:** Queries URLhaus for a specific URL.
    *   **Request Body:** `{"query": "http://example.com/malicious.exe"}`
    *   **Response:** A serialized `MalwareIndicator` object with the `raw_data` from the API.
*   **`POST /api/v1/malware-intel/host/`**
    *   **Action:** Queries URLhaus for a host (domain or IP).
    *   **Request Body:** `{"query": "evil-domain.com"}`
    *   **Response:** A serialized `MalwareIndicator` object.
*   **`POST /api/v1/malware-intel/hash/`**
    *   **Action:** Queries URLhaus for a file hash.
    *   **Request Body:** `{"query": "123abc..."}`
    *   **Response:** A serialized `MalwareIndicator` object.

## 5. Configuration

*   `URLHAUS_AUTH_KEY`: Will need to be acquired and added to the `.env` file and loaded in `settings.py`.
*   `URLHAUS_API_BASE_URL`: `https://urlhaus-api.abuse.ch` will be a constant in `services.py`.
